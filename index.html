<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Graveyard Dashboard</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.min.js"></script>

    <style>
        /* Global Box Sizing */
        * { box-sizing: border-box; }

        body {
            background-color: #000;
            color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh; width: 100vw;
        }

        header {
            background-color: #0b1026;
            border-bottom: 1px solid #333;
            padding: 0 2%;
            height: 6vh; min-height: 40px;
            display: flex; align-items: center;
        }

        h1 { margin: 0; font-size: 1.2rem; color: #4facfe; letter-spacing: 1px; }

        .container { display: flex; flex: 1; height: 94vh; width: 100%; }

        /* Sidebar */
        .sidebar {
            width: 20%; min-width: 220px; max-width: 300px;
            background: #0f1219;
            border-right: 1px solid #333;
            padding: 2%;
            display: flex; flex-direction: column; gap: 1.5vh;
        }

        .menu-btn {
            background: transparent; border: none; color: #888;
            text-align: left; padding: 1.5vh 1vw;
            font-size: 1rem; cursor: pointer; border-radius: 4px;
            transition: 0.2s; width: 100%;
        }
        .menu-btn:hover { background: #1f2330; color: #fff; }
        .menu-btn.active { background: #4facfe; color: #000; font-weight: bold; }

        .desc-box {
            margin-top: auto; background: #1a1d26; padding: 2%;
            font-size: 0.85rem; color: #bbb; border-radius: 5px;
            line-height: 1.4; max-height: 30vh; overflow-y: auto;
        }

        /* Viz Area */
        .main {
            flex: 1; position: relative;
            background: radial-gradient(circle at center, #1b2735 0%, #000 100%);
            width: 100%; height: 100%; overflow: hidden;
        }

        .viz-box { width: 100%; height: 100%; display: none; }
        .viz-box.active { display: block; }
        canvas { display: block; width: 100%; height: 100%; }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #4facfe;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 0.9rem;
            display: none; z-index: 9999;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
            white-space: pre-line;
        }

        #loader {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #4facfe; font-size: 1.5rem; text-align: center;
        }

        .chart-controls { position: absolute; top: 2%; right: 2%; z-index: 100; }
        .toggle-btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 0.5rem 1rem; cursor: pointer; font-size: 0.8rem;
        }
        .toggle-btn:hover { background: #555; }

        /* Chart Styles */
        .bar { fill: #ff9f43; } .bar:hover { fill: #ffca85; }
        .axis text { fill: #888; font-size: 0.8rem; }
        .axis line, .axis path { stroke: #444; }
        .axis-label { fill: #fff; font-size: 0.9rem; text-anchor: middle; }
        
        .ref-line { stroke: #2ecc71; stroke-width: 2; stroke-dasharray: 5,5; }
        .ref-label { fill: #2ecc71; font-size: 0.7rem; }
        .ref-line-red { stroke: #e74c3c; stroke-width: 2; stroke-dasharray: 5,5; }
        .ref-label-red { fill: #e74c3c; font-size: 0.7rem; }
    </style>
</head>
<body>

<header>
    <h1>ORBITAL GRAVEYARD</h1>
</header>

<div class="container">
    <div class="sidebar">
        <button class="menu-btn active" onclick="setViz('globe')">1. 4D Live Globe</button>
        <button class="menu-btn" onclick="setViz('altitude')">2. Altitude Analysis</button>
        <button class="menu-btn" onclick="setViz('years')">3. Timeline</button>

        <div class="desc-box" id="desc">
            <strong>4D Live Globe</strong><br><br>
            Real-time tracking of current orbital debris.<br><br>
            <strong>Hover</strong> over dots to identify objects.<br>
            <strong>Drag</strong> to rotate Earth.
        </div>
    </div>

    <div class="main">
        <div id="loader">Loading Data...</div>
        <div id="tooltip"></div>

        <div id="globe" class="viz-box active">
            <canvas id="globe-canvas"></canvas>
        </div>

        <div id="altitude" class="viz-box">
            <div class="chart-controls">
                <button class="toggle-btn" onclick="toggleAltRange()">Toggle LEO / Full Range</button>
            </div>
            <div id="alt-svg-container" style="width:100%; height:100%;"></div>
        </div>

        <div id="years" class="viz-box"></div>
    </div>
</div>

<script>
    // --- GLOBAL STATE ---
    let satellites = [];
    let currentViz = 'globe';
    let showFullRange = false; 
    
    // --- 1. DATA LOADING ---
    d3.csv("space_debris.csv").then(data => {
        processData(data);
        document.getElementById('loader').style.display = 'none';
        
        initGlobe();
        window.addEventListener('resize', handleResize);
        
    }).catch(e => {
        console.error(e);
        document.getElementById('loader').innerHTML = "Error loading space_debris.csv";
    });

    function processData(data) {
        satellites = [];
        const now = new Date();
        data.forEach(row => {
            const l1 = row.TLE_LINE1 || row.LINE1;
            const l2 = row.TLE_LINE2 || row.LINE2;
            if (l1 && l2) {
                const satRec = satellite.twoline2satrec(l1, l2);
                const posVel = satellite.propagate(satRec, now);
                let alt = 0;
                if (posVel.position) {
                    const r = Math.sqrt(Math.pow(posVel.position.x, 2) + Math.pow(posVel.position.y, 2) + Math.pow(posVel.position.z, 2));
                    alt = r - 6371;
                }
                let year = null;
                const dStr = row.LAUNCH_DATE || row.EPOCH;
                if(dStr) { const d = new Date(dStr); if(!isNaN(d)) year = d.getFullYear(); }

                satellites.push({ rec: satRec, name: row.OBJECT_NAME || "UNKNOWN", alt: alt, year: year });
            }
        });
    }

    function handleResize() {
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(() => {
            if (currentViz === 'globe') initGlobe();
            if (currentViz === 'altitude') renderAltitude();
            if (currentViz === 'years') renderYears();
        }, 100);
    }

    // --- 2. MENU ---
    const descText = {
        'globe': "<strong>4D Live Globe</strong><br><br>Green = LEO (Fast)<br>Red = GEO (Stationary relative to Earth).<br>Hover for Lat/Lon details.",
        'altitude': "<strong>Altitude Density</strong><br><br>Use toggle to switch between LEO focus (0-2000km) and Full Range.",
        'years': "<strong>Timeline</strong><br><br>Debris count by launch year."
    };

    window.setViz = function(id) {
        document.querySelectorAll('.viz-box').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        document.querySelectorAll('.menu-btn').forEach(e => e.classList.remove('active'));
        const idx = ['globe', 'altitude', 'years'].indexOf(id);
        document.querySelectorAll('.menu-btn')[idx].classList.add('active');

        document.getElementById('desc').innerHTML = descText[id];
        currentViz = id;

        if(id === 'globe') initGlobe(); 
        if(id === 'altitude') renderAltitude();
        if(id === 'years') renderYears();
    };

    // --- 3. GLOBE ---
    let canvas, ctx, projection, path, renderLoop;

    function initGlobe() {
        const container = document.getElementById('globe');
        canvas = document.getElementById('globe-canvas');
        
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        canvas.width = width;
        canvas.height = height;
        ctx = canvas.getContext('2d');

        projection = d3.geoOrthographic()
            .scale(Math.min(width, height) / 2.2) 
            .translate([width / 2, height / 2])
            .clipAngle(90);

        path = d3.geoPath().projection(projection).context(ctx);

        d3.select(canvas).call(d3.drag().on('drag', (e) => {
            const r = projection.rotate();
            const k = 75 / projection.scale();
            projection.rotate([r[0] + e.dx * k, r[1] - e.dy * k]);
        }));
        
        d3.select(canvas).on('mousemove', onGlobeHover);

        if (!renderLoop) startAnim();
    }

    let mousePos = null;
    function onGlobeHover(event) {
        const rect = canvas.getBoundingClientRect();
        mousePos = [event.clientX - rect.left, event.clientY - rect.top];
    }

    function startAnim() {
        d3.json("https://unpkg.com/world-atlas@2.0.2/countries-110m.json").then(world => {
            const land = topojson.feature(world, world.objects.countries);
            const sphere = { type: "Sphere" };

            function step() {
                if(currentViz !== 'globe') { 
                    renderLoop = requestAnimationFrame(step); 
                    return; 
                }

                const width = canvas.width;
                const height = canvas.height;

                ctx.clearRect(0,0,width,height);
                ctx.beginPath(); path(sphere); ctx.fillStyle = '#0b1026'; ctx.fill();
                ctx.beginPath(); path(land); ctx.fillStyle = '#1c3018'; ctx.fill(); ctx.strokeStyle = '#333'; ctx.stroke();

                const now = new Date();
                const center = projection.invert([width/2, height/2]);
                let hoveredSat = null;
                let minDist = 15;

                satellites.forEach(sat => {
                    const pv = satellite.propagate(sat.rec, now);
                    if(!pv.position) return;
                    
                    const gmst = satellite.gstime(now);
                    const gd = satellite.eciToGeodetic(pv.position, gmst);
                    const lon = satellite.degreesLong(gd.longitude);
                    const lat = satellite.degreesLat(gd.latitude);

                    if (d3.geoDistance(center, [lon, lat]) > 1.57) return;

                    const xy = projection([lon, lat]);
                    if(xy) {
                        ctx.fillStyle = sat.alt > 20000 ? '#ff4d4d' : '#00ff88';
                        ctx.beginPath();
                        ctx.arc(xy[0], xy[1], 1.5, 0, 2*Math.PI);
                        ctx.fill();

                        if (mousePos) {
                            const dx = mousePos[0] - xy[0];
                            const dy = mousePos[1] - xy[1];
                            const dist = Math.sqrt(dx*dx + dy*dy);
                            if (dist < minDist) {
                                minDist = dist;
                                hoveredSat = { ...sat, lat: lat, lon: lon };
                            }
                        }
                    }
                });

                const tooltip = document.getElementById('tooltip');
                if (hoveredSat) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = (mousePos[0] + 15) + 'px';
                    tooltip.style.top = (mousePos[1] + 15) + 'px';
                    // --- CHANGED: Added Lat/Lon back to tooltip ---
                    tooltip.innerHTML = `<strong>${hoveredSat.name}</strong>
                    Alt: ${Math.round(hoveredSat.alt)} km
                    Lat: ${hoveredSat.lat.toFixed(2)}°
                    Lon: ${hoveredSat.lon.toFixed(2)}°`;
                    
                    const xy = projection([hoveredSat.lon, hoveredSat.lat]);
                    ctx.beginPath(); ctx.arc(xy[0], xy[1], 5, 0, 2*Math.PI);
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
                } else {
                    tooltip.style.display = 'none';
                }
                renderLoop = requestAnimationFrame(step);
            }
            renderLoop = requestAnimationFrame(step);
        });
    }

    // --- 4. ALTITUDE CHART ---
    window.toggleAltRange = function() {
        showFullRange = !showFullRange;
        renderAltitude();
    }

    function renderAltitude() {
        const container = document.getElementById('alt-svg-container');
        container.innerHTML = "";
        
        const w = container.clientWidth;
        const h = container.clientHeight;
        const m = {top: h*0.1, right: w*0.05, bottom: h*0.15, left: w*0.1}; 

        const svg = d3.select("#alt-svg-container").append("svg")
            .attr("width", w).attr("height", h)
            .append("g").attr("transform", `translate(${m.left},${m.top})`);

        const maxAlt = showFullRange ? 40000 : 2000;
        const data = satellites.map(d => d.alt).filter(d => d > 200 && d < maxAlt);

        const x = d3.scaleLinear().domain([200, maxAlt]).range([0, w - m.left - m.right]);
        const histogram = d3.bin().domain(x.domain()).thresholds(x.ticks(showFullRange ? 100 : 40));
        const bins = histogram(data);
        const y = d3.scaleLinear().domain([0, d3.max(bins, d => d.length)]).range([h - m.top - m.bottom, 0]);

        // Bars
        svg.selectAll("rect").data(bins).enter().append("rect")
            .attr("x", 1)
            .attr("transform", d => `translate(${x(d.x0)}, ${y(d.length)})`)
            .attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 1))
            .attr("height", d => h - m.top - m.bottom - y(d.length))
            .attr("class", "bar")
            .on("mouseover", (e, d) => {
                const tt = document.getElementById('tooltip');
                tt.style.display = 'block';
                tt.style.left = (e.pageX + 10) + 'px';
                tt.style.top = (e.pageY - 10) + 'px';
                tt.innerHTML = `Range: ${d.x0}-${d.x1} km\nCount: ${d.length}`;
            })
            .on("mouseout", () => document.getElementById('tooltip').style.display = 'none');

        // Axes
        svg.append("g").attr("transform", `translate(0,${h-m.top-m.bottom})`).call(d3.axisBottom(x));
        svg.append("g").call(d3.axisLeft(y));

        // X Label
        svg.append("text").attr("class", "axis-label")
            .attr("x", (w - m.left - m.right)/2).attr("y", h - m.top)
            .text(`Altitude (km)`);

        // --- CHANGED: Added Y-Axis Label ---
        svg.append("text").attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - m.left + 15)
            .attr("x", 0 - (h / 2) + m.top)
            .style("text-anchor", "middle")
            .text("Count of Objects");

        if (!showFullRange) {
            const issX = x(400);
            svg.append("line").attr("x1", issX).attr("x2", issX).attr("y1", 0).attr("y2", h-m.top-m.bottom).attr("class", "ref-line");
            svg.append("text").attr("x", issX+5).attr("y", 10).text("ISS").attr("class", "ref-label");
            
            const ssoX = x(800);
            svg.append("line").attr("x1", ssoX).attr("x2", ssoX).attr("y1", 0).attr("y2", h-m.top-m.bottom).attr("class", "ref-line-red");
            svg.append("text").attr("x", ssoX+5).attr("y", 10).text("SSO").attr("class", "ref-label-red");
        }
    }

    // --- 5. YEARS CHART ---
    function renderYears() {
        const div = document.getElementById('years');
        div.innerHTML = "";
        const w = div.clientWidth, h = div.clientHeight;
        const m = {top: h*0.1, right: w*0.05, bottom: h*0.15, left: w*0.1};

        const svg = d3.select("#years").append("svg").attr("width", w).attr("height", h)
            .append("g").attr("transform", `translate(${m.left},${m.top})`);

        const roll = d3.rollups(satellites.filter(d => d.year > 1957), v => v.length, d => d.year).sort((a,b)=>a[0]-b[0]);

        const x = d3.scaleBand().range([0, w - m.left - m.right]).domain(roll.map(d=>d[0])).padding(0.2);
        const y = d3.scaleLinear().range([h - m.top - m.bottom, 0]).domain([0, d3.max(roll, d=>d[1])]);

        svg.append("g").attr("transform", `translate(0,${h-m.top-m.bottom})`).call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%5))));
        svg.append("g").call(d3.axisLeft(y));

        svg.selectAll(".bar").data(roll).enter().append("rect")
            .attr("class", "bar")
            .attr("x", d=>x(d[0])).attr("y", d=>y(d[1]))
            .attr("width", x.bandwidth()).attr("height", d=> h - m.top - m.bottom - y(d[1]))
            .style("fill", "#d04a35");
            
        // X Label
        svg.append("text").attr("class", "axis-label")
            .attr("x", (w-m.left-m.right)/2).attr("y", h - m.top)
            .text("Launch Year");

        // --- CHANGED: Added Y-Axis Label ---
        svg.append("text").attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - m.left + 15)
            .attr("x", 0 - (h / 2) + m.top)
            .style("text-anchor", "middle")
            .text("Count of Objects");
    }

</script>
</body>
</html>
